---
title: "IPUMS Data in R"
author: "Institute for Social Research and Data Innovation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{IPUMS Data in R}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(ipumsr)
```

## Obtaining IPUMS Data

IPUMS data are free, but do require registration. New users can register
with a particular [IPUMS project](https://www.ipums.org/overview) by
clicking the **Register** link at the top right of the project website.

IPUMS data are obtained by creating and submitting an *extract request*.
This specifies the data to be included in the resulting *extract* (or
*data extract*). A submitted extract request will be processed by the
IPUMS servers. When complete, the extract containing the requested data
can be downloaded.

Extracts typically contain both data and metadata files. Data files
typically come as .dat (for fixed-width files) or .csv (for
comma-delimited files). Metadata files contain information about the
data file and its contents, including variable descriptions and parsing
instructions for fixed-width data files. Microdata projects provide
metadata in DDI (.xml) files. Aggregate data projects provide metadata
in either .txt or .csv formats.

Registered users can download IPUMS data from a particular project
through the interactive extract system found on that project's website.
For some projects, data can also be downloaded within R by interacting
with the IPUMS API.

### Downloading from the IPUMS Website

To create a new extract request, navigate to the extract interface for
the IPUMS project of interest by clicking **Select Data** in the heading
of the project website. The project extract interface allows you to
specify the data you'd like to download. The data selection parameters
will differ across projects; see each project's documentation for more
details on the available options. If you've never created an extract for
the project you're interested in, start by watching the project-specific
video on creating extracts hosted on the [IPUMS Tutorials
page](https://www.ipums.org/support/tutorials).

#### For microdata projects

Once your extract is ready, click the green **Download** button to
download the data file. Then, right-click the **DDI** link in the
codebook column, and select **Save Link As...** (see below).

Note that some browsers may display different text, but there should be
an option to download the DDI file as .xml. For instance, on Safari,
select **Download Linked File As...**. The most important thing is that
you download the file in .xml format, *not* .html format.

![](microdata_annotated_screenshot.png){width="1000"}

#### For aggregate data projects

Simply download an extract's data by clicking the green **Tables**
button (for tabular data) and/or **GIS Files** button (for spatial
boundary data) in the **Download Data** column.

### Downloading via the IPUMS API

Extract requests can also be created and submitted from within R by
interacting with the IPUMS API. The IPUMS API currently supports the
following collections:

-   IPUMS USA

-   IPUMS CPS

-   IPUMS NHGIS

The workflow for requesting and downloading data via API is
straightforward: first, define the parameters of your extract, then
submit the extract. After waiting for it to complete, you can download
the files directly to your local machine without ever having to leave R:

```{r, eval=FALSE}
extract_request <- define_extract_nhgis(
  description = "Using the IPUMS API",
  datasets = "1990_STF1",
  data_tables = c("NP1", "NP2", "NP3"),
  geog_levels = "state"
)

submitted_extract <- submit_extract(extract_request)
downloadable_extract <- wait_for_extract(submitted_extract)
data_files <- download_extract(downloadable_extract)
```

You can also access previous extract requests, even if they weren't made
with the API:

```{r, eval=FALSE}
past_extracts <- get_extract_history("nhgis")
```

See the associated [vignette](ipums-api.html) for more details about how
to use ipumsr to interact with the IPUMS API.

## Reading Data

Once your extract is downloaded, you can load your data into R with the
family of `read_*()` functions in ipumsr. These functions expand on
those provided in [readr](https://readr.tidyverse.org/index.html) in two
ways:

-   ipumsr anticipates standard IPUMS file structures, limiting the need
    for users to manually decompress and organize their downloaded files
    before reading.

-   ipumsr uses an extract's metadata files to automatically attach
    contextual information to the data. This allows users to easily
    identify variable names, variable descriptions, and labeled data
    values (from [haven](https://haven.tidyverse.org/)), which are
    common in IPUMS files.

For microdata files, use the `read_ipums_micro_*()` family:

```{r}
cps_file <- ipums_example("cps_00006.xml")
cps_data <- read_ipums_micro(cps_file)

head(cps_data)
```

For NHGIS files, use `read_nhgis()`:

```{r}
nhgis_file <- ipums_example("nhgis0972_csv.zip")
nhgis_data <- read_nhgis(nhgis_file, show_col_types = FALSE)

head(nhgis_data)
```

ipumsr also supports the reading of IPUMS spatial boundary files into
the `sf` format provided by the [sf](https://r-spatial.github.io/sf/)
package:

```{r, eval = requireNamespace("sf")}
shp_file <- ipums_example("nhgis0972_shape_small.zip")
nhgis_shp <- read_ipums_sf(shp_file)

head(nhgis_shp)
```

ipumsr is primarily designed to read data produced by the IPUMS extract
system. However, IPUMS does distribute other files, often available via
direct download. In many cases, these can be loaded with ipumsr.
Otherwise, these files can likely be handled by existing data reading
packages like [readr](https://readr.tidyverse.org/) (for delimited
files) or [haven](https://haven.tidyverse.org/) (for Stata, SPSS, or SAS
files).

See the [vignette](ipums-read.html) focused on reading IPUMS data for
more information.

## Exploring Metadata

Load metadata information with `read_ipums_ddi()` (for microdata
projects) and `read_nhgis_codebook()` (for NHGIS). These store file and
variable-level metadata for a given data source, which can be used to
interpret the data contents.

```{r}
cps_meta <- read_ipums_ddi(cps_file)
nhgis_meta <- read_nhgis_codebook(nhgis_file)
```

Summarize the variable metadata for a dataset using `ipums_var_info()`:

```{r}
ipums_var_info(cps_meta)
```

You can also get contextual details for specific variables:

```{r}
ipums_var_desc(cps_data$INCTOT)

ipums_val_labels(cps_data$STATEFIP)
```

ipumsr also provides a family of `lbl_*()` functions to assist in
accessing and manipulating the value-level metadata included in IPUMS
data. This allows for value labels to be incorporated into the data
processing pipeline. For instance:

```{r}
# Remove labels for values that do not appear in the data
cps_data$STATEFIP <- lbl_clean(cps_data$STATEFIP)

ipums_val_labels(cps_data$STATEFIP)
```

```{r}
# Combine North and South Dakota into a single value/label pair
cps_data$STATEFIP <- lbl_relabel(
  cps_data$STATEFIP,
  lbl("38_46", "Dakotas") ~ grepl("Dakota", .lbl)
)

ipums_val_labels(cps_data$STATEFIP)
```

See the [value labels](value-labels.html) vignette for more details.
